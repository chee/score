/*global require:false*/(function(e,t,n,r){"use strict";function s(){var e=r.defer();return n.readFile("scores","utf-8",function(t,n){t?e.reject(new Error(t)):e.resolve(n)}),e.promise}function o(e){return s().then(function(n){var r=JSON.parse(n),i=Object.keys(r),s=i[i.length-1],o=+s+t.random(1,24);return u({score:+o,name:e})})}function u(e){return s().then(function(t){var n=JSON.parse(t);return n[e.score]=e.name,a(JSON.stringify(n))})}function a(e){return r.nfcall(n.writeFile,"scores",e)}var i=e();return i.set("title","Scores"),i.use(e.bodyParser()),i.use(e.static(__dirname+"/public")),i.get("/",function(e,t){t.redirect("/index.html")}),i.get("/longget",function(e,t){var n=(new Date).toLocaleTimeString();t.header("Content-Type","text/event-stream"),t.header("Cache-Control","no-cache"),t.header("Connection","keep-alive")}),i.get("/get",function(e,t){var n=s();n.then(function(e){t.header("Content-Type","application/json"),t.header("Cache-Control","no-cache"),t.send(200,e)}).fail(function(){t.send(404,"FUCK")})}),i.post("/put",function(e,t){var n=e.body.player;n&&n.length<11?o(n,t).then(function(){t.send(200,"yay")}):t.send(404,"FUCK")}),i})(require("express"),require("lodash"),require("fs"),require("q")).listen(3e3);